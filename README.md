# n8n + PostgreSQL + Cloudflare Tunnel (OpenTofu)

OpenTofu stack that spins up three Docker containers on the same network (n8n, PostgreSQL, and cloudflared) and provisions the Cloudflare tunnel plus CNAME.

## Requirements
- Docker Engine (local Docker API available; Compose is **not** required)
- [OpenTofu](https://opentofu.org/) or a Terraform-compatible runtime (>= 1.6)

## Variable configuration (`terraform.tfvars`)
1. Copy `terraform.tfvars.example` to `terraform.tfvars`.
2. Fill the fields you need (tunnel token, domain, container names/images, etc.).
3. Run `tofu plan` (the file is auto-loaded; no TF_VAR export needed).

## Available variables
| Variable | Description | Default |
| --- | --- | --- |
| `cloudflare_api_token` | Cloudflare API token (optional, useful for automations). | `null` |
| `cloudflare_account_id` | Cloudflare Account ID (required to create tunnel and CNAME). | `null` |
| `cloudflare_zone_id` | Cloudflare Zone ID. | `null` |
| `cloudflare_domain` | Base domain published through the tunnel. | `app.example.com` |
| `n8n_cname` | CNAME prefix for n8n (e.g., `n8n`, `app`). | `null` |
| `enable_cloudflare_tunnel` | Toggle for creating the Cloudflare tunnel and CNAME records. | `true` |
| `cloudflare_managed_tunnel_name` | Friendly tunnel name. | `null` |
| `cloudflare_catch_all_ingress_service` | Default catch-all service for cloudflared ingress. | `http://n8n:5678` |
| `postgres_user` | Postgres user used by n8n. | `n8n` |
| `postgres_password` | Postgres password. | _no default_ |
| `postgres_db` | Postgres database name. | `n8n` |
| `postgres_port` | Internal Postgres port (container); not published on host. | `5432` |
| `n8n_port` | Internal n8n port (container/tunnel); not published on host. | `5678` |
| `n8n_host` | Host used by n8n to build public URLs. | `null` |
| `n8n_container_name` | n8n container name. | `n8n` |
| `n8n_image` | n8n Docker image. | `n8nio/n8n:1.66.1` |
| `n8n_3dx_build_enabled` | If true, builds a custom n8n image (3DX nodes baked in) from `docker/n8n-custom`. | `false` |
| `n8n_3dx_image_name` | Name/tag for the custom 3DX n8n image. | `n8n-3dx:latest` |
| `keep_images_locally` | If true, keeps Docker images locally (disables auto cleanup). | `false` |
| `postgres_container_name` | Postgres container name. | `n8n-postgres` |
| `postgres_image` | Postgres Docker image. | `postgres:15-alpine` |
| `cloudflared_container_name` | cloudflared container name. | `n8n-cloudflared` |
| `cloudflared_image` | cloudflared Docker image. | `cloudflare/cloudflared:latest` |

## Provisioning
```bash
tofu init
tofu plan
tofu apply
```

## Outputs
- `n8n_service`: public hostname, internal port, container name, and image for n8n.
- `postgres_service`: container, image, internal port, and basic credentials (without password) for Postgres.
- `cloudflared_connector`: cloudflared container, tunnel name/ID, provisioned CNAME, and target.
- `cloudflare_dns`: DNS record details created in Cloudflare (name, type, proxied).
- `docker_network`: Docker network name shared by the services.

## What is created
- `n8n` container (`n8nio/n8n`) exposing port 5678 (tunable via `TF_VAR_n8n_port`).
- `n8n-postgres` container (`postgres:15-alpine`) with a persistent data volume.
- `n8n-cloudflared` container (`cloudflare/cloudflared`) running `tunnel run` with the token generated by the tunnel resource.
- Docker network `n8n_network` connecting the three services.
- Docker volumes to persist n8n and Postgres data.
- Cloudflare Zero Trust tunnel (`cloudflare_zero_trust_tunnel_cloudflared`), its ingress config, and `cloudflare_record` creating the CNAME pointing to the tunnel.

## Notes
- The tunnel is created and configured via the Cloudflare provider; the `cloudflared` container consumes the token from `cloudflare_zero_trust_tunnel_cloudflared`.
- Set `n8n_host` (in `terraform.tfvars`) to the public hostname the tunnel will expose (e.g., the Cloudflare subdomain) so n8n builds correct URLs.
- `terraform.tfvars` and OpenTofu state files are already in `.gitignore` to avoid committing secrets.
- Optional fields like `cloudflare_api_token`, `cloudflare_account_id`, and `cloudflare_zone_id` are required for the provider; `cloudflare_managed_tunnel_name` and `cloudflare_catch_all_ingress_service` customize the tunnel setup.
